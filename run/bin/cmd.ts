#!/usr/bin/env -S deno run --allow-all

import { $ } from 'npm:zx';
import { Command } from 'npm:commander';
import { setSecretsOnLocal, setEnvOnLocal } from '../utils/divers.ts';

////////////////////////////////////////////////////////////////////////////////
// VERBOSE BY DEFAULT
////////////////////////////////////////////////////////////////////////////////

$.verbose = false;

////////////////////////////////////////////////////////////////////////////////
// STARTING PROGRAM
////////////////////////////////////////////////////////////////////////////////

const program = new Command();

////////////////////////////////////////////////////////////////////////////////
// COMMAND
////////////////////////////////////////////////////////////////////////////////

import commandAction from '../lib/action.ts';
import commandCustom from '../lib/custom.ts';
import commandDocker from '../lib/docker.ts';
import commandHasura from '../lib/hasura.ts';
import commandMachine from '../lib/machine.ts';
import commandNpm from '../lib/npm.ts';
import commandTerraform from '../lib/terraform.ts';
import commandTunnel from '../lib/tunnel.ts';
import commandUtils from '../lib/utils.ts';
import commmandVault from '../lib/vault.ts';

////////////////////////////////////////////////////////////////////////////////
// MAIN ENTRY POINT
////////////////////////////////////////////////////////////////////////////////

program.name('run');
program
  .option('--cible <env context>', 'target environment context')
  .hook('preAction', async (thisCommand) => {
    if (!Deno.env.get('GITHUB_ACTIONS')) {
      const { cible } = thisCommand.opts();
      await setSecretsOnLocal(cible || 'local');
      await setEnvOnLocal();
    }
  });

////////////////////////////////////////////////////////////////////////////////
// GIT COMMAND
////////////////////////////////////////////////////////////////////////////////

await commandAction(program);
await commandCustom(program);
await commandDocker(program);
await commandHasura(program);
await commandMachine(program);
await commandNpm(program);
await commandTerraform(program);
await commandTunnel(program);
await commandUtils(program);
await commmandVault(program);

////////////////////////////////////////////////////////////////////////////////
// PROGRAM EXIT
////////////////////////////////////////////////////////////////////////////////

program.exitOverride();

////////////////////////////////////////////////////////////////////////////////
// PARSING ARGUMENTS
////////////////////////////////////////////////////////////////////////////////

try {
  await program.parseAsync();
} catch (err) {
  const { exitCode, name, code, message } = err;

  if (!message.includes('outputHelp')) {
    console.log(message);
    console.error('something went wrong');
  }
}

////////////////////////////////////////////////////////////////////////////////
// THE END
////////////////////////////////////////////////////////////////////////////////
